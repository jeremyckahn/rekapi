<!DOCTYPE html>
<html>
<head>
  <link href="../lib/shifty/tests/qunit/qunit.css" rel="stylesheet" type="text/css" />
  <script src="../lib/shifty/tests/qunit/qunit.js"></script>
  <script src="../lib/underscore/underscore.js"></script>
  <script src="../lib/shifty/dist/shifty.js"></script>
  <script src="../src/rekapi.core.js"></script>
  <script src="../src/rekapi.actor.js"></script>
  <script src="../src/rekapi.keyframeprops.js"></script>
  <script src="../src/rekapi.canvas.js"></script>
  <script src="../src/rekapi.dom.js"></script>
  <script>
  function setupTestKapi () {
    var sandbox
        ,kapi
        ,actor;

    sandbox = document.getElementById('sandbox');
    kapi = new Kapi(sandbox);

    kapi.canvas_style('background', '#ddd');
    kapi.canvas_height(300);
    kapi.canvas_width(500);

    return kapi;
  }

  function  setupTestActor (forKapi) {
    var actor;

    actor = new Kapi.Actor({
      'draw': function (canvas_context, state) {
        canvas_context.beginPath();
          canvas_context.arc(
            this.x || 0,
            this.y || 0,
            this.radius || 0,
            0,
            Math.PI*2,
            true);
          canvas_context.fillStyle = this.color || '#f0f';
          canvas_context.fill();
          canvas_context.closePath();

          return this;
      }
    });

    forKapi.addActor(actor);
    return actor;
  }

  (function () {

    module('Actor management');

    test('Actors are added successfully', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      // setupTestActor calls addActor
      testActor1 = setupTestActor(testKapi);

      equals(testKapi._actors[testActor1.id], testActor1,
          'Actor is in the internal _actors Object');

      equals(testKapi._drawOrder[0], testActor1.id,
          'Actor is the first element in the internal _drawOrder array');
    });


    test('Actors can only be added once', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);

      testKapi.addActor(testActor1);

      equals(testKapi.actorCount(), 1,
          'The actor was not added twice');
    });


    test('Actors can be retrieved from the Kapi', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);

      equals(testKapi.getActor(testActor1.id), testActor1,
          'Can reference the Actor inside the Kapi via the actor ID.');
    });


    test('Actors can be moved to the beginning of the draw list', function () {
      var testKapi
          ,testActor1
          ,testActor2;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);
      testActor2 = setupTestActor(testKapi);
      testKapi.moveActorToLayer(testActor2, 0);

      equals(testKapi._drawOrder[0], testActor2.id,
          'Second actor was moved to the first position.');

      equals(testKapi._drawOrder[1], testActor1.id,
          'First actor was moved to the second position.');

      equals(testKapi.actorCount(), 2,
          'Draw list size did not change.');
    });


    test('Actors can be moved to the end of the draw list', function () {
      var testKapi
          ,testActor1
          ,testActor2;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);
      testActor2 = setupTestActor(testKapi);
      testKapi.moveActorToLayer(testActor1, 1);

      equals(testKapi._drawOrder[0], testActor2.id,
          'Second actor was moved to the first position.');

      equals(testKapi._drawOrder[1], testActor1.id,
          'First actor was moved to the second position.');

      equals(testKapi.actorCount(), 2,
          'Draw list size did not change.');
    });


    test('Actors can move themselves.', function () {
      var testKapi
          ,testActor1
          ,testActor2;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);
      testActor2 = setupTestActor(testKapi);
      testActor1.moveToLayer(1);

      equals(testKapi._drawOrder[0], testActor2.id,
          'Second actor was moved to the first position.');

      equals(testKapi._drawOrder[1], testActor1.id,
          'First actor was moved to the second position.');

      equals(testKapi.actorCount(), 2,
          'Draw list size did not change.');
    });


    test('Actors can be retrieved from the Kapi', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);

      equals(testKapi.getActor(testActor1.id), testActor1,
          'Can reference the Actor inside the Kapi via the actor ID.');
    });


    test('Actors are removed successfully', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);
      testKapi.removeActor(testActor1)

      equals(testKapi._actors[testActor1.id], undefined,
          'Actor is no longer in the internal _actors Object');

      equals(testKapi._drawOrder.indexOf(testActor1.id), -1,
          'Actor is not in the internal _drawOrder array');
    });


    module('Actor introspection');

    test('Actor track with KeyframeProperties can be measured', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);

      testActor1
        .keyframe(0, { x: 1 })
        .keyframe(1000, { x: 2 })
        .keyframe(2000, { x: 3 });

      equals(testActor1.getTrackLength('x'), 3,
          'Track with Actors has a length');
    });


    test('Actor track with no KeyframeProperties cannot be measured', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);

      testActor1
        .keyframe(0, {})
        .keyframe(1000, {})
        .keyframe(2000, {});

      equals(testActor1.getTrackLength('x'), undefined,
          'Track with Actors does not have a length');
    });


    test('Actor track names can be retrieved', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);

      testActor1
        .keyframe(0, {
          a: 1
          ,b: 2
          ,c: 3
          ,d: 4
        });

      var trackNames = testActor1.getTrackNames();

      ok(_.contains(trackNames, 'a'), 'Track "a" exists');
      ok(_.contains(trackNames, 'b'), 'Track "b" exists');
      ok(_.contains(trackNames, 'c'), 'Track "c" exists');
      ok(_.contains(trackNames, 'd'), 'Track "d" exists');
      equals(trackNames.length, 4, 'There are only 4 track names');
    });


    test('KeyframeProperties can be retrieved from an Actor', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);

      testActor1
        .keyframe(0, {
          a: 1
        });

      ok(testActor1.getKeyframeProperty('a', 0) instanceof Kapi.KeyframeProperty,
          'getKeyframeProperty returned a KeyframeProperty');
    });


    module('Animation timeline');

    test('Calculate animation length with one Actor', function () {
      var testKapi
          ,testActor1;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);

      testActor1
        .keyframe(0, { x: 1 })
        .keyframe(1000, { x: 2 })
        .keyframe(2000, { x: 3 });

      equals(testKapi.animationLength(), 2000,
          'Length of the animation was calculated');
    });


    test('Calculate animation length with multiple Actors', function () {
      var testKapi
          ,testActor1
          ,testActor2;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);
      testActor2 = setupTestActor(testKapi);

      testActor1
        .keyframe(0, { x: 1})
        .keyframe(1000, { x: 2})
        .keyframe(2000, { x: 3});

      testActor2
        .keyframe(0, { x: 1 })
        .keyframe(5000, { x: 2 });

      equals(testKapi.animationLength(), 5000,
          'Length of the animation was calculated');
    });


    test('An Actor does not show before it has reached its first keyframe'
      ,function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);

      testActor
        .keyframe(1000, { x: 1 })
        .keyframe(2000, { x: 2 });

      testKapi.calculateActorPositions(500);

      equals(testActor.isShowing(), false,
          'Actor has not yet gotten state');

      testKapi.calculateActorPositions(1500);

      equals(testActor.isShowing(), true,
          'Actor has gotten state');
    });


    test('An Actor does not show after it passes its last keyframe'
      ,function () {
      var testKapi
          ,testActor1
          ,testActor2;

      testKapi = setupTestKapi();
      testActor1 = setupTestActor(testKapi);
      testActor2 = setupTestActor(testKapi);

      testActor1
        .keyframe(0, { x: 1 })
        .keyframe(2000, { x: 2 });

      testActor2
        .keyframe(500, { x: 1 })
        .keyframe(1500, { x: 2 });

      testKapi.calculateActorPositions(1000);

      equals(testActor2.isShowing(), true,
          'Actor has state');


      testKapi.calculateActorPositions(1750);

      equals(testActor2.isShowing(), false,
          'Actor no longer has state');
    });


    module('Actor data');

    test('Can set arbitrary data on the Actor'
    ,function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      testActor.data({
        'test': 'hello'
      });

      equals(testActor._data.test, 'hello', 'Data was set.');
    });


    module('Actor export');

    test('Exported Actor data has key data points', function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      testActor.keyframe(0, {
        'x': 1
        ,'y': 10
      }).keyframe(1000, {
        'x': 2
        ,'y': 20
      });

      var exportedTimeline = testActor.exportTimeline();
      equals(exportedTimeline.start, 0,
          'Actor start time is properly exported');
      equals(exportedTimeline.end, 1000,
          'Actor end time is properly exported');
      ok(_.contains(exportedTimeline.trackNames, 'x'),
          '"x"" track is in the trackName list');
      ok(_.contains(exportedTimeline.trackNames, 'y'),
          '"y"" track is in the trackName list');
      equals(exportedTimeline.trackNames.length, 2,
          'Only two track names were exported');
      equals(exportedTimeline.propertyTracks.x.length, 2,
          'Data for all "x" KeyframeProperties was exported')
      equals(exportedTimeline.propertyTracks.y.length, 2,
          'Data for all "y" KeyframeProperties was exported')
      equals(typeof exportedTimeline.propertyTracks.x[0].id, 'string',
          'First exported x KeyframeProperty has an id');
      console.log(exportedTimeline)
    });

    module('context');

    test('Can set Canvas context', function () {
      var testKapi = new Kapi(document.createElement('canvas'));

      ok(testKapi.canvas_getContext() instanceof CanvasRenderingContext2D,
          'Context is a canvas');
    });


    test('Can set DOM element context', function () {
      var testKapi = new Kapi(document.createElement('div'));

      ok(testKapi.canvas_getContext() instanceof HTMLElement,
          'Context is a DOM element');
    });


    test('Can set Object context', function () {
      var testKapi = new Kapi({});

      // I'm pretty sure this is the most convoluted way to see if an Object
      // is an empty, pure Object
      equals(testKapi.canvas_getContext().__proto__.__proto__, null,
          'Context is an Object');
    });

  } ());
  </script>
</head>
<body>
  <h1 id="qunit-header"><a href="https://github.com/jeremyckahn/rekapi">Rekapi</a></h1>
   <h2 id="qunit-banner"></h2>
   <div id="qunit-testrunner-toolbar"></div>
   <h2 id="qunit-userAgent"></h2>
   <ol id="qunit-tests"></ol>
   <div id="qunit-fixture"></div>
  <canvas id="sandbox"></canvas>
</body>
</html>
