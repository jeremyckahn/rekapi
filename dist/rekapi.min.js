/*jslint browser: true, nomen: true, plusplus: true, undef: true, vars: true, white: true */
/**
 * Rekapi - Rewritten Kapi. v0.9.6 (Sun, 17 Jun 2012 22:10:37 GMT)
 * https://github.com/jeremyckahn/rekapi
 *
 * By Jeremy Kahn (jeremyckahn@gmail.com), with significant contributions from
 *   Franck Lecollinet
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore),
 *   Shifty.js (https://github.com/jeremyckahn/shifty).
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(a){function b(a,b,c,d){c.each(a._events[b],function(b){b(a,d)})}function c(){}var d=function(a,c,d){function g(a,b){var c=Math.floor(b/a._animationLength);return c}function h(a){return r()-a._loopTimestamp}function i(a,b){return b>=a._timesToIterate&&a._timesToIterate!==-1}function j(a,d){i(a,d)&&(a.stop(),b(a,"animationComplete",c))}function k(a,b,c){var d;return i(a,c)?d=a._animationLength:d=b%a._animationLength,d}function l(a,b){var c=g(a,b),d=k(a,b,c);a.update(d),j(a,c)}function m(a){l(a,h(a))}function n(a){var b=function(){n(a),m(a)};a._scheduleUpdate.call?a._loopId=a._scheduleUpdate.call(f,b,1e3/a.config.fps):a._loopId=setTimeout(b,1e3/a.config.fps)}function o(a){var b;return a!==60?b=f.setTimeout:b=f.requestAnimationFrame||f.webkitRequestAnimationFrame||f.oRequestAnimationFrame||f.msRequestAnimationFrame||f.mozCancelRequestAnimationFrame&&f.mozRequestAnimationFrame||f.setTimeout,b}function p(a){var b;return a!==60?b=f.clearTimeout:b=f.cancelAnimationFrame||f.webkitCancelAnimationFrame||f.oCancelAnimationFrame||f.msCancelAnimationFrame||f.mozCancelRequestAnimationFrame||f.clearTimeout,b}function q(a){a._cancelUpdate.call?a._cancelUpdate.call(f,a._loopId):clearTimeout(a._loopId)}"use strict";var e=Function,f=e("return this")(),r=d.util.now,s={fps:60},t={STOPPED:"stopped",PAUSED:"paused",PLAYING:"playing"},u=a.Kapi||function(b){return this.config=b||{},this.context=this.config.context||{},this._actors={},this._playState=t.STOPPED,this._events={animationComplete:[],playStateChange:[],play:[],pause:[],stop:[],beforeUpdate:[],afterUpdate:[],addActor:[],removeActor:[]},this._timesToIterate=-1,this._animationLength=0,this._loopId=null,this._loopTimestamp=null,this._pausedAtTime=null,this._lastUpdatedMillisecond=0,c.extend(this.config,b),c.defaults(this.config,s),this._scheduleUpdate=o(this.config.fps),this._cancelUpdate=p(this.config.fps),c.each(this._contextInitHook,function(a){a.call(this)},this),this};u.prototype._contextInitHook={},u.prototype._recalculateAnimationLength=function(){var a=[];return c.each(this._actors,function(b){a.push(b.getEnd())}),this._animationLength=Math.max.apply(Math,a),this},u.prototype.addActor=function(a){return c.contains(this._actors,a)||(a.context()||a.context(this.context),a.kapi=this,a.fps=this.framerate(),this._actors[a.id]=a,this._recalculateAnimationLength(),a.setup(),b(this,"addActor",c,a)),this},u.prototype.getActor=function(a){return this._actors[a]},u.prototype.getActorIds=function(){return c.pluck(this._actors,"id")},u.prototype.getAllActors=function(){return c.clone(this._actors)},u.prototype.removeActor=function(a){return delete this._actors[a.id],delete a.kapi,a.teardown(),this._recalculateAnimationLength(),b(this,"removeActor",c,a),this},u.prototype.play=function(a){return q(this),this._playState===t.PAUSED?this._loopTimestamp+=r()-this._pausedAtTime:this._loopTimestamp=r(),this._timesToIterate=a||-1,this._playState=t.PLAYING,n(this),c.each(this._actors,function(a){a._state.isPaused&&a.resume()}),b(this,"playStateChange",c),b(this,"play",c),this},u.prototype.playFrom=function(a,b){return this.play(b),this._loopTimestamp=r()-a,this},u.prototype.playFromCurrent=function(a){return this.playFrom(this._lastUpdatedMillisecond,a)},u.prototype.pause=function(){return this._playState===t.PAUSED?this:(this._playState=t.PAUSED,q(this),this._pausedAtTime=r(),c.each(this._actors,function(a){a._state.isTweening&&a.pause()}),b(this,"playStateChange",c),b(this,"pause",c),this)},u.prototype.stop=function(){return this._playState=t.STOPPED,q(this),c.each(this._actors,function(a){a.stop()}),b(this,"playStateChange",c),b(this,"stop",c),this},u.prototype.isPlaying=function(){return this._playState===t.PLAYING},u.prototype.animationLength=function(){return this._animationLength},u.prototype.lastPositionUpdated=function(){return this._lastUpdatedMillisecond/this._animationLength},u.prototype.actorCount=function(){return c.size(this._actors)},u.prototype.framerate=function(a){return a&&(this.config.fps=a,this._scheduleUpdate=o(this.config.fps),this._cancelUpdate=p(this.config.fps)),this.config.fps},u.prototype.update=function(a){return b(this,"beforeUpdate",c),c.each(this._actors,function(b){b.updateState(a),typeof b.update=="function"&&b.update(b.context(),b.get())}),this._lastUpdatedMillisecond=a,b(this,"afterUpdate",c),this},u.prototype.on=function(a,b){if(!this._events[a])return;return this._events[a].push(b),this},u.prototype.off=function(a,b){if(!this._events[a])return;return b?this._events[a]=c.without(this._events[a],b):this._events[a]=[],this},u.prototype.exportTimeline=function(){var a={duration:this._animationLength,actors:{}};return c.each(this._actors,function(b){a.actors[b.id]=b.exportTimeline()},this),a},u.util={},c.extend(u.util,{calculateLoopPosition:k,calculateTimeSinceStart:h}),typeof KAPI_DEBUG!="undefined"&&KAPI_DEBUG===!0&&(u._private={calculateLoopPosition:k,updateToCurrentMillisecond:m,tick:n,determineCurrentLoopIteration:g,calculateTimeSinceStart:h,isAnimationComplete:i,updatePlayState:j}),a.Kapi=u},e=function(a,b,d){function g(a){return a.sort(function(a,b){return a-b})}function h(a,b){var c=a._timelinePropertyCacheIndex,d=c.length,e;for(e=1;e<d;e++)if(c[e]>=b)return e-1;return-1}function i(a){b.each(a._propertyTracks,function(c,d){a._propertyTracks[d]=b.sortBy(a._propertyTracks[d],function(a){return a.millisecond})})}function j(a){b.each(a._timelinePropertyCaches,function(c,d){var e=k(a,+d);b.defaults(c,e)})}function k(a,c){var d={};return b.each(a._propertyTracks,function(a,e){var f=null;b.find(a,function(a){return a.millisecond>c?d[e]=f:a.millisecond===c&&(d[e]=a),f=a,!!d[e]});if(!d[e]){var g=b.last(a);g&&g.millisecond<=c&&(d[e]=g)}}),d}function l(a){b.each(a._propertyTracks,function(a,c){b.each(a,function(b,c){b.linkToNext(a[c+1])})})}function m(a,c,d){return b.find(a._propertyTracks[c],function(a){return a.millisecond===d})}function n(a){a._timelinePropertyCaches={},b.each(a._keyframeProperties,function(b){a._timelinePropertyCaches[b.millisecond]||(a._timelinePropertyCaches[b.millisecond]={}),a._timelinePropertyCaches[b.millisecond][b.name]=b},a),a._timelinePropertyCacheIndex=b.keys(a._timelinePropertyCaches),b.each(a._timelinePropertyCacheIndex,function(b,c){a._timelinePropertyCacheIndex[c]=+b},a),g(a._timelinePropertyCacheIndex),j(a),l(a)}"use strict";var e="linear",f=a.Kapi,o=f.Actor=function(a){return a=a||{},d.call(this),b.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},id:b.uniqueId(),setup:a.setup||c,update:a.update||c,teardown:a.teardown||c}),a.context&&this.context(a.context),this},p=function(){};p.prototype=d.prototype,o.prototype=new p,o.prototype.context=function(a){return a&&(this._context=a),this._context},o.prototype.keyframe=function(c,d,g){var h;return g=g||e,typeof g=="string"&&(h=g,g={},b.each(d,function(a,b){g[b]=h})),b.each(d,function(a,b){g[b]=g[b]||e}),b.each(d,function(a,b){var d=new f.KeyframeProperty(this,c,b,a,g[b]);this._keyframeProperties[d.id]=d,this._propertyTracks[b]||(this._propertyTracks[b]=[]),this._propertyTracks[b].push(d),i(this)},this),this.kapi&&this.kapi._recalculateAnimationLength(),n(this),this},o.prototype.getKeyframeProperty=function(a,b){if(this._propertyTracks[a]&&this._propertyTracks[a][b])return this._propertyTracks[a][b]},o.prototype.modifyKeyframeProperty=function(a,b,c){return this._propertyTracks[a]&&this._propertyTracks[a][b]&&this._propertyTracks[a][b].modifyWith(c),i(this),n(this),this},o.prototype.getTrackNames=function(){return b.keys(this._propertyTracks)},o.prototype.getTrackLength=function(a){if(!this._propertyTracks[a])return;return this._propertyTracks[a].length},o.prototype.copyProperties=function(a,c){var d={},e={};return b.each(this._propertyTracks,function(a,b){var f=m(this,b,c);f&&(d[b]=f.value,e[b]=f.easing)},this),this.keyframe(a,d,e),this},o.prototype.wait=function(a){var c=this.getEnd();if(a<=c)return this;var d=this.getEnd(),e=k(this,this.getEnd()),f={},g={};return b.each(e,function(a,b){f[b]=a.value,g[b]=a.easing}),this.removeKeyframe(d),this.keyframe(d,f,g),this.keyframe(a,f,g),this},o.prototype.getStart=function(){var a=[];return b.each(this._propertyTracks,function(b){b.length&&a.push(b[0].millisecond)}),a.length===0&&(a=[0]),Math.min.apply(Math,a)},o.prototype.getEnd=function(){var a=0;return b.each(this._propertyTracks,function(c){if(c.length){var d=b.last(c).millisecond;d>a&&(a=d)}},this),a},o.prototype.getLength=function(){return this.getEnd()-this.getStart()},o.prototype.hasKeyframeAt=function(a,c){var d=this._propertyTracks;if(c){if(!b.has(d,c))return!1;d=b.pick(d,c)}return b.find(d,function(b,c){return m(this,c,a)!==undefined},this)!==undefined},o.prototype.modifyKeyframe=function(a,c,d){return d=d||{},b.each(this._propertyTracks,function(b,e){var f=m(this,e,a);f&&f.modifyWith({value:c[e],easing:d[e]})},this),this},o.prototype.removeKeyframe=function(a){return b.each(this._propertyTracks,function(c,d){var e=-1,f=!1;b.find(c,function(b){return e++,f=a===b.millisecond,f});if(f){var g=c.splice(e,1)[0];g&&delete this._keyframeProperties[g.id]}},this),this.kapi&&this.kapi._recalculateAnimationLength(),n(this),this},o.prototype.removeAllKeyframeProperties=function(){return b.each(this._propertyTracks,function(a,b){a.length=0},this),this._keyframeProperties={},this.removeKeyframe(0)},o.prototype.updateState=function(a){var c=this.getStart(),d=this.getEnd();if(c<=a&&a<=d){var e=h(this,a),f=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[e]],g={};b.each(f,function(b,c){b&&(g[c]=b.getValueAt(a))}),this.set(g)}return this},o.prototype.data=function(a){return a&&(this._data=a),this._data},o.prototype.exportTimeline=function(){var a={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};return b.each(this._propertyTracks,function(c,d){var e=a.propertyTracks[d]=[];b.each(c,function(a){e.push(a.exportPropertyData())})}),a}},f=function(a,b,c){"use strict";var d="linear",e=a.Kapi,f=e.KeyframeProperty=function(a,c,e,f,g){return this.id=b.uniqueId("keyframeProperty_"),this.ownerActor=a,this.millisecond=c,this.name=e,this.value=f,this.easing=g||d,this.nextProperty=null,this};f.prototype.modifyWith=function(a){var c={};b.each(["millisecond","easing","value"],function(b){c[b]=typeof a[b]=="undefined"?this[b]:a[b]},this),b.extend(this,c)},f.prototype.linkToNext=function(a){this.nextProperty=a||null},f.prototype.getValueAt=function(a){var b={},d={},e;if(this.nextProperty){b[this.name]=this.value,d[this.name]=this.nextProperty.value;var f=this.nextProperty.millisecond-this.millisecond,g=(a-this.millisecond)/f;e=c.util.interpolate(b,d,g,this.nextProperty.easing)[this.name]}else e=this.value;return e},f.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},g=function(a,c){function e(a,b,c){return typeof c!="undefined"&&(a[b]=c,a.style[b]=c+"px"),a[b]}function f(a){a.config.clearOnUpdate&&a.canvasClear()}function g(a){b(a,"beforeDraw",c);var d=a._drawOrder.length,e;if(a._drawOrderSorter){var f=c.sortBy(a._canvasActors,a._drawOrderSorter);e=c.pluck(f,"id")}else e=a._drawOrder;var g,h,i;for(i=0;i<d;i++)g=a._canvasActors[e[i]],h=g.context(),g.draw(h,g.get());return b(a,"afterDraw",c),a}function h(a,b){b instanceof d.CanvasActor&&(a._drawOrder.push(b.id),a._canvasActors[b.id]=b)}function i(a,b){b instanceof d.CanvasActor&&(a._drawOrder=c.without(a._drawOrder,b.id),delete a._canvasActors[b.id])}"use strict";var d=a.Kapi;d.prototype._contextInitHook.canvas=function(){this._drawOrder=[],this._drawOrderSorter=null,this._canvasActors={},this.config.clearOnUpdate=!0,c.extend(this._events,{beforeDraw:[],afterDraw:[]}),c.each(["Height","Width"],function(a){var b=a.toLowerCase();this.config[b]&&(this["canvas"+a](this.config[b]),delete this.config[a])},this),this.on("afterUpdate",g),this.on("addActor",h),this.on("removeActor",i),this.on("beforeDraw",f)},d.prototype.canvasHeight=function(a){return e(this.context,"height",a)},d.prototype.canvasWidth=function(a){return e(this.context,"width",a)},d.prototype.canvasClear=function(){return this.context.getContext&&this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight()),this},d.prototype.canvasContext=function(){return this.context.getContext("2d")},d.prototype.redraw=function(){return g(this),this},d.prototype.moveActorToLayer=function(a,b){if(b<this._drawOrder.length)return this._drawOrder=c.without(this._drawOrder,a.id),this._drawOrder.splice(b,0,a.id),a;return},d.prototype.setOrderFunction=function(a){return this._drawOrderSorter=a,this},d.prototype.unsetOrderFunction=function(){return this._drawOrderSorter=null,this},d.prototype.exportTimeline=function(){var a={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};return c.each(this._drawOrder,function(b){a.actors[b]=this._actors[b].exportTimeline()},this),a}},h=function(a,b){function e(){}"use strict";var d=a.Kapi;e.prototype=d.Actor.prototype;var f=d.CanvasActor=function(a){return d.Actor.call(this,a),a=a||{},this.draw=a.draw||c,this};f.prototype=new e,f.prototype.context=function(a){return a&&(this._context=a),this._context&&this._context.getContext("2d")},f.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)}},i=function(a,b){function e(a,b,c){a.style[b]=c}function f(){}"use strict";var c=a.Kapi,d=["transform","webkitTransform","MozTransform","oTransform","msTransform"];c.DOMActor=function(a){c.Actor.call(this),this._context=a;var b=this.getCSSName();return this._context.className.match(b)||(this._context.className+=" "+b),delete this.update,delete this.teardown,this},f.prototype=c.Actor.prototype,c.DOMActor.prototype=new f,f.prototype.update=function(a,c){b.each(c,function(c,f){f==="transform"?b.each(d,function(b){e(a,b,c)},this):e(a,f,c)},this)},f.prototype.teardown=function(a,c){var d=this._context.className.match(/\S+/g),e=b.without(d,this.getCSSName());this._context.className=e},f.prototype.getCSSName=function(){return"actor-"+this.id}},j=function(a,b){function i(a){return/rgb/.test(a)}function j(a){var c=["{"],d;return b.each(a.get(),function(a,b){d=a;var f=b;b==="transform"&&(f=e),c.push(f+":"+d+";")}),c.push("}"),c.join("")}function k(a,b){var c=a.getLength(),d=a.getStart(),e=[],f,g,h,i=c/b,k=Math.floor(i),l=c/100,m=d+i,n=c+d-i;a.updateState(d),e.push("  from "+j(a));var o;for(o=m;o<=n;o+=i)a.updateState(o),f=(o-d)/l,g=+f.toFixed(2),h=g+"% ",e.push("  "+h+j(a));return a.updateState(c+d),e.push("  to "+j(a)),e.join("\n")}function l(a,c,d){d=d||["w3"];var e=[];return b.each(d,function(b){var d=p(g,[f[b],c,a]),h=m(d,b);e.push(h)}),e.join("\n")}function m(a,b){var c=new RegExp(e,"g"),d=f[b]+"transform",g=a.replace(c,d);return g}function n(a,c,d){c=c||["w3"];var e=[],f;b.each(c,function(b){f=o(a,b,d),e.push(f)});var g=p(h,[d,e.join("\n")]);return g}function o(a,b,c){var d=[],e=f[b],g=a.getStart(),h=a.getEnd()-g;h=p("  %sanimation-duration: %sms;",[e,h]),d.push(h);var i=p("  %sanimation-name: %s;",[e,c+"-keyframes"]);d.push(i);var j=p("  %sanimation-delay: %sms;",[e,g]);d.push(j);var k=p("  %sanimation-fill-mode: forwards;",[e]);return d.push(k),d.join("\n")}"use strict";var c=a.Kapi,d=100,e="TRANSFORM",f=c.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},g=["@%skeyframes %s-keyframes {","%s","}"].join("\n"),h=[".%s {","  position: absolute;","%s","}"].join("\n");a.Kapi.prototype.toCSS=function(a){a=a||{};var c=[],d=this.getActorIds();return b.each(d,function(b){c.push(this.getActor(b).toCSS(a))},this),c.join("\n")},a.Kapi.Actor.prototype.toCSS=function(a){a=a||{};var b=[],c=a.name||this.getCSSName(),e=a.granularity||d,f=n(this,a.vendors,c);b.push(f);var g=k(this,e),h=l(g,c,a.vendors);return b.push(h),b.join("\n")};var p=c.util.printf=function(a,c){var d=a;return b.each(c,function(a){d=d.replace("%s",a)}),d}},k=function(a,b){"use strict";var c=b?{}:a,k=b&&b.underscore?b.underscore:c._,l=b&&b.Tweenable?b.Tweenable:c.Tweenable;return d(c,k,l),e(c,k,l),f(c,k,l),typeof i=="function"&&i(c,k,l),typeof j=="function"&&j(c,k,l),typeof g=="function"&&g(c,k,l),typeof h=="function"&&h(c,k,l),c.Kapi};if(typeof define=="function"&&define.amd){var l=typeof _!="undefined";define(["shifty","underscore"],function(b,c){var d=c!==null,e={Tweenable:b,underscore:d?c:_},f=k(a,e);return typeof KAPI_DEBUG!="undefined"&&KAPI_DEBUG===!0&&(f.underscore_version=e.underscore.VERSION),!l&&d&&(a._=undefined),f})}else k(typeof a!="undefined"?a:this)})(this)