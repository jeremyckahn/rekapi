/**
 * Rekapi - Rewritten Kapi. v0.5.2
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(r){var v=function(g,f){function h(b){return b.sort(function(b,a){return b-a})}function j(b,a){return Math.floor(a/b._animationLength)}function k(b){return i()-b._loopTimestamp}function l(b,a){return a>=b._timesToIterate&&-1!==b._timesToIterate}function p(b,a){l(b,a)&&(b.stop(),m(b,"onAnimationComplete"))}function q(b,a,d){return l(b,d)?b._animationLength:a%b._animationLength}function e(b){var a=k(b),d;d=j(b,a);a=q(b,a,d);b.render(a);p(b,d)}function o(b){b._loopId=setTimeout(function(){o(b);
e(b)},1E3/b.config.fps)}function m(b,a){c.each(b._events[a],function(a){a(b)})}var c=f&&f.underscore?f.underscore:g._,n=f&&f.Tweenable?f.Tweenable:g.Tweenable,a={fps:30,height:150,width:300,doRoundNumbers:!1,clearOnUpdate:!0},i=n.util.now,d=g.Kapi||function(b,d){this.canvas=b;this._contextType=null;this.canvas_setContext(b);this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],
onPlay:[],onPause:[],onStop:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;c.extend(this.config,d);c.defaults(this.config,a);c.each(["height","width"],function(b){this.config[b]&&(this["canvas_"+b](this.config[b]),delete this.config[b])},this);return this};d.prototype.addActor=function(b){c.contains(this._actors,b)||(b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup());
return this};d.prototype.getActor=function(b){return this._actors[b]};d.prototype.getActorIds=function(){return c.pluck(this._actors,"id")};d.prototype.getAllActors=function(){return c.clone(this._actors)};d.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=c.without(this._drawOrder,b.id);b.teardown();this.updateInternalState();return this};d.prototype.play=function(b){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+
(i()-this._pausedAtTime):i();this._timesToIterate=b||-1;this._playState="playing";o(this);c.each(this._actors,function(b){b._state.isPaused&&b.resume()});m(this,"onPlayStateChange");m(this,"onPlay");return this};d.prototype.playFrom=function(b,a){this.play(a);this._loopTimestamp=i()-b;return this};d.prototype.playFromCurrent=function(b){return this.playFrom(this._lastRenderedMillisecond,b)};d.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";clearTimeout(this._loopId);
this._pausedAtTime=i();c.each(this._actors,function(b){b._state.isTweening&&b.pause()});m(this,"onPlayStateChange");m(this,"onPause");return this};d.prototype.stop=function(b){this._playState="stopped";clearTimeout(this._loopId);!0===b&&this.canvas_clear();c.each(this._actors,function(a){a.stop();!0===b&&a.hide()});m(this,"onPlayStateChange");m(this,"onStop");return this};d.prototype.isPlaying=function(){return"playing"===this._playState};d.prototype.animationLength=function(){return this._animationLength};
d.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};d.prototype.actorCount=function(){return this._drawOrder.length};d.prototype.framerate=function(b){b&&(this.config.fps=b);return this.config.fps};d.prototype.render=function(b){this.calculateActorPositions(b);this.draw();this._lastRenderedMillisecond=b;m(this,"onFrameRender");return this};d.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};d.prototype.calculateActorPositions=
function(b){var a,d,c;c=n.util.isRoundingEnabled();this.config.doRoundNumbers?n.util.enableRounding():n.util.disableRounding();d=this._drawOrder.length;for(a=0;a<d;a++)this._actors[this._drawOrder[a]].calculatePosition(b);!0===c?n.util.enableRounding():n.util.disableRounding();return this};d.prototype.draw=function(){var b,a,d,i,e;this.config.clearOnUpdate&&this.canvas_clear();a=this._drawOrder.length;i=this.canvas_getContext();this._drawOrderSorter?(b=c.sortBy(this._actors,this._drawOrderSorter),
e=c.pluck(b,"id")):e=this._drawOrder;for(b=0;b<a;b++)d=this._actors[e[b]],d.isShowing()&&d.draw(i,d.get());return this};d.prototype.updateInternalState=function(){var b=[];c.each(this._actors,function(a){b.push(a.getEnd())});this._animationLength=Math.max.apply(Math,b);return this};d.prototype.moveActorToLayer=function(b,a){if(a<this._drawOrder.length)return this._drawOrder=c.without(this._drawOrder,b.id),this._drawOrder.splice(a,0,b.id),b};d.prototype.bind=function(b,a){if(this._events[b])return this._events[b].push(a),
this};d.prototype.unbind=function(a,d){if(this._events[a])return this._events[a]=d?c.without(this._events[a],d):[],this};d.prototype.setOrderFunction=function(a){this._drawOrderSorter=a;return this};d.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};d.prototype.exportTimeline=function(){var a={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};c.each(this._drawOrder,function(d){a.actors[d]=this._actors[d].exportTimeline()},this);return a};
d.util={};c.extend(d.util,{noop:function(){},sortNumerically:h,calculateLoopPosition:q,calculateTimeSinceStart:k});"undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG&&(d._private={sortNumerically:h,calculateLoopPosition:q,renderCurrentMillisecond:e,tick:o,determineCurrentLoopIteration:j,calculateTimeSinceStart:k,isAnimationComplete:l,updatePlayState:p});g.Rekapi=g.Kapi=d},w=function(g,f){function h(a,c){var d,b,e;e=a._timelinePropertyCacheIndex;b=e.length;for(d=1;d<b;d++)if(e[d]>=c)return d-1;return-1}
function j(a){c.each(a._propertyTracks,function(i,d){a._propertyTracks[d]=c.sortBy(a._propertyTracks[d],function(a){return a.millisecond})})}function k(a){c.each(a._timelinePropertyCaches,function(i,d){var b={};c.each(a._propertyTracks,function(a,i){var e=null;c.find(a,function(a){a.millisecond>d&&(b[i]=e);e=a;return!!b[i]})});c.defaults(i,b)})}function l(a){c.each(a._propertyTracks,function(a){c.each(a,function(d,b){d.linkToNext(a[b+1])})})}function p(a,i,d){return c.find(a._propertyTracks[i],function(a){return a.millisecond===
d})}function q(a,i,d,b){var e=c.keys(a._propertyTracks),h=c.keys(i),e=c.difference(e,h),f={};c.each(e,function(d){var i;i=a._propertyTracks[d].slice(0).reverse();c.each(i,function(a){a.millisecond<b&&!f[d]&&(f[d]={value:a.value,easing:a.easing})})});c.each(f,function(a,b){i[b]=a.value;d[b]=a.easing})}var e,o,m,c=f&&f.underscore?f.underscore:g._,n=f&&f.Tweenable?f.Tweenable:g.Tweenable;e=g.Kapi;o=0;e.Actor=function(a){a=a||{};this.constructor.call(this);c.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},
_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isShowing:!1,_isPersisting:!1,id:o++,setup:a.setup||e.util.noop,draw:a.draw||e.util.noop,teardown:a.teardown||e.util.noop});return this};m=function(){};m.prototype=n.prototype;e.Actor.prototype=new m;e.Actor.prototype.keyframe=function(a,i,d){var b;d||(d="linear");"string"===typeof d&&(b=d,d={},c.each(i,function(a,c){d[c]=b}));c.each(i,function(a,b){d[b]=d[b]||"linear"});q(this,i,d,a);c.each(i,function(b,c){var i;i=new e.KeyframeProperty(this,
a,c,b,d[c]);this._keyframeProperties[i.id]=i;this._propertyTracks[c]||(this._propertyTracks[c]=[]);this._propertyTracks[c].push(i);j(this)},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};e.Actor.prototype.getKeyframeProperty=function(a,c){if(this._propertyTracks[a]&&this._propertyTracks[a][c])return this._propertyTracks[a][c]};e.Actor.prototype.modifyKeyframeProperty=function(a,c,d){this._propertyTracks[a]&&this._propertyTracks[a][c]&&this._propertyTracks[a][c].modifyWith(d);
j(this);this.invalidatePropertyCache();return this};e.Actor.prototype.getTrackNames=function(){return c.keys(this._propertyTracks)};e.Actor.prototype.getTrackLength=function(a){if(this._propertyTracks[a])return this._propertyTracks[a].length};e.Actor.prototype.copyProperties=function(a,i){var d,b;d={};b={};c.each(this._propertyTracks,function(a,c){var e;if(e=p(this,c,i))d[c]=e.value,b[c]=e.easing},this);this.keyframe(a,d,b);return this};e.Actor.prototype.wait=function(a){var c=this.getEnd();if(a<=
c)return this;this.copyProperties(a,c);return this};e.Actor.prototype.getStart=function(){var a=[];c.each(this._propertyTracks,function(c){c.length&&a.push(c[0].millisecond)});0===a.length&&(a=[0]);return Math.min.apply(Math,a)};e.Actor.prototype.getEnd=function(){var a=0;c.each(this._propertyTracks,function(i){i.length&&(i=c.last(i).millisecond,i>a&&(a=i))},this);return a};e.Actor.prototype.getLength=function(){return this.getEnd()-this.getStart()};e.Actor.prototype.modifyKeyframe=function(a,i,d){d=
d||{};c.each(this._propertyTracks,function(b,c){var e=p(this,c,a);e&&e.modifyWith({value:i[c],easing:d[c]})},this);return this};e.Actor.prototype.removeKeyframe=function(a){c.each(this._propertyTracks,function(e){var d=-1;c.find(e,function(b){d++;return a===b.millisecond});(e=e.splice(d,1)[0])&&delete this._keyframeProperties[e.id]},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};e.Actor.prototype.removeAllKeyframeProperties=function(){c.each(this._propertyTracks,
function(a){a.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};e.Actor.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};e.Actor.prototype.show=function(a){this._isShowing=!0;this._isPersisting=!!a;return this};e.Actor.prototype.hide=function(a){this._isShowing=!1;!0===a&&(this._isPersisting=!1);return this};e.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};e.Actor.prototype.calculatePosition=function(a){var e,d,
b;e=this.getStart();d=this.getEnd();this.hide();e<=a&&a<=d&&(this.show(),e=h(this,a),e=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[e]],b={},c.each(e,function(d,c){b[c]=d.getValueAt(a)}),this.set(b));return this};e.Actor.prototype.data=function(a){a&&(this._data=a);return this._data};e.Actor.prototype.exportTimeline=function(){var a={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};c.each(this._propertyTracks,function(e,d){var b=a.propertyTracks[d]=
[];c.each(e,function(a){b.push(a.exportPropertyData())})});return a};e.Actor.prototype.invalidatePropertyCache=function(){this._timelinePropertyCaches={};c.each(this._keyframeProperties,function(a){this._timelinePropertyCaches[a.millisecond]||(this._timelinePropertyCaches[a.millisecond]={});this._timelinePropertyCaches[a.millisecond][a.name]=a},this);this._timelinePropertyCacheIndex=c.keys(this._timelinePropertyCaches);c.each(this._timelinePropertyCacheIndex,function(a,c){this._timelinePropertyCacheIndex[c]=
+a},this);e.util.sortNumerically(this._timelinePropertyCacheIndex);k(this);l(this)};c.each(["tween","to"],function(a){e.Actor.prototype[a]=function(){this.show(!0);n.prototype[a].apply(this,arguments)}},this)},x=function(g){function f(h,f,g,l){"undefined"!==typeof l&&(h[g]=l,h.style||(h.style={}),h.style[g]=l+"px");return f===f.HTML_ELEMENT?h.style[g]:h[g]}g=g.Kapi;g.prototype.canvas_setContext=function(f){var g;this._canvas=f;g=f.nodeName;void 0===g?(this._context={},this._contextType="other"):"CANVAS"===
g?(this._context=f.getContext("2d"),this._contextType="canvas"):(this._context=f,this._contextType="HTMLElement");return this.canvas_getContext()};g.prototype.canvas_getContext=function(){return this._context};g.prototype.canvas_height=function(g){return f(this.canvas,this._contextType,"height",g)};g.prototype.canvas_width=function(g){return f(this.canvas,this._contextType,"width",g)};g.prototype.canvas_style=function(f,g){"undefined"!==typeof g&&this.canvas.style&&(this.canvas.style[f]=g);return this.canvas.style[f]};
g.prototype.canvas_clear=function(){"canvas"===this._contextType&&this.canvas_getContext().clearRect(0,0,this.canvas_width(),this.canvas_height());return this}},y=function(g,f){var h,j=f&&f.underscore?f.underscore:g._,k=f&&f.Tweenable?f.Tweenable:g.Tweenable;h=g.Kapi;h.KeyframeProperty=function(f,g,h,e,o){this.id=j.uniqueId("keyframeProperty_");this.ownerActor=f;this.millisecond=g;this.name=h;this.value=e;this.easing=o||"linear";this.nextProperty=null;return this};h.KeyframeProperty.prototype.modifyWith=
function(f){var g={};j.each(["millisecond","easing","value"],function(h){g[h]="undefined"===typeof f[h]?this[h]:f[h]},this);j.extend(this,g)};h.KeyframeProperty.prototype.linkToNext=function(f){this.nextProperty=f||null};h.KeyframeProperty.prototype.getValueAt=function(f){var g,h,e;g={};h={};this.nextProperty?(g[this.name]=this.value,h[this.name]=this.nextProperty.value,e=this.nextProperty.millisecond-this.millisecond,f=(f-this.millisecond)/e,g=k.util.interpolate(g,h,f,this.nextProperty.easing)[this.name]):
g=null;return g};h.KeyframeProperty.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},s=function(g){var f=g.Kapi,h=["transform","webkitTransform","MozTransform","oTransform","msTransform"];g.getComputedStyle&&(f.DOMActor=function(j){var k;k=new f.Actor({setup:function(){var f=this.kapi.canvas_getContext();"static"===g.getComputedStyle(f).getPropertyValue("position")&&(this.kapi.canvas_getContext().style.position=
"relative");"static"===g.getComputedStyle(j).getPropertyValue("position")&&(j.style.position="absolute");this.hide()},draw:function(f,g){var k;k=!1;_.each(g,function(e,f){k=!0;"rotate"===f?_.each(h,function(f){j.style[f]="rotate("+e+"deg)"}):j.style[f]=e});k?this.show():this.hide()}});j.classList.add(k.getCSSName());k.show=function(g){f.Actor.prototype.show.call(this,g);j.style.display="block"};k.hide=function(g){f.Actor.prototype.hide.call(this,g);j.style.display="none"};return k},g.Kapi.Actor.prototype.getCSSName=
function(){return"actor-"+this.id})},t=function(g,f){function h(e){var f=["{"],c;_.each(e.get(),function(e,a){if(/rgb/.test(e))c=e;else{var g=e.match(/\D*$/);c=parseFloat(e).toFixed(2)+g}f.push(a+":"+c+";")});f.push("}");return f.join("")}function j(f,g,c){var c=c||["w3"],h=[];_.each(c,function(a){a=e(p,[l[a],g,f]);h.push(a)});return h.join("\n")}function k(f,g){var g=g||["w3"],c=[],h;_.each(g,function(a){var g=[],a=l[a],d=f.getStart(),b=f.getEnd()-d,b=e("  %sanimation-duration: %sms;",[a,b]);g.push(b);
b=e("  %sanimation-name: %s;",[a,f.getCSSName()+"-keyframes"]);g.push(b);d=e("  %sanimation-delay: %sms;",[a,d]);g.push(d);a=e("  %sanimation-fill-mode: forwards;",[a]);g.push(a);h=g.join("\n");c.push(h)});return e(q,[f.getCSSName(),c.join("\n")])}var l=g.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},p="@%skeyframes %s-keyframes {\n%s\n}",q=".%s {\n  position: absolute;\n%s\n}";f.Kapi.prototype.toCSS=function(e){var e=e||{},f=[],c=this.getActorIds();_.each(c,
function(c){f.push(this.getActor(c).toCSS(e))},this);return f.join("\n")};f.Kapi.Actor.prototype.toCSS=function(e){var e=e||{},f=[],c=e.granularity||100,g=k(this,e.vendors);f.push(g);for(var g=this.getLength(),a=this.getStart(),i=[],d,b=g/c,l=g/100,c=a;c<=g+a;c+=b)this.calculatePosition(c),d=(c-a)/l,d=0===d?"from ":100===d?"to ":d.toFixed(2)+"% ",i.push("  "+d+h(this));g=i.join("\n");e=j(g,this.getCSSName(),e.vendors);f.push(e);return f.join("\n")};var e=g.util.printf=function(e,f){var c=e;_.each(f,
function(e){c=c.replace("%s",e)});return c}},u=function(g,f){var h=f?{}:g;v(h,f);w(h,f);x(h,f);y(h,f);"function"===typeof s&&s(h,f);"function"===typeof t&&t(h.Kapi,h,f);return h.Kapi};if("function"===typeof define&&define.amd){var z="undefined"!==typeof _;define(["shifty","underscore"],function(g,f){var h={Tweenable:g,underscore:null!==f?f:_},j=u(r,h);"undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG&&(j.underscore_version=h.underscore.VERSION);z||delete r._;return j})}else u("undefined"!==typeof r?
r:this)})(this);
