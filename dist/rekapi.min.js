/**
 * Rekapi - Rewritten Kapi. v0.6.1
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(r){var v=function(h,f){function d(b){return b.sort(function(b,a){return b-a})}function k(b,a){return Math.floor(a/b._animationLength)}function m(b){return e()-b._loopTimestamp}function n(b,a){return a>=b._timesToIterate&&-1!==b._timesToIterate}function q(b,a){n(b,a)&&(b.stop(),j(b,"onAnimationComplete"))}function o(b,a,c){return n(b,c)?b._animationLength:a%b._animationLength}function i(b){var a=m(b),c;c=k(b,a);a=o(b,a,c);b.render(a);q(b,c)}function l(b){b._loopId=setTimeout(function(){l(b);
i(b)},1E3/b.config.fps)}function j(b,a){g.each(b._events[a],function(a){a(b)})}var g=f&&f.underscore?f.underscore:h._,p=f&&f.Tweenable?f.Tweenable:h.Tweenable,a={fps:30,height:150,width:300,doRoundNumbers:!1,clearOnUpdate:!0},e=p.util.now,c=h.Kapi||function(b,c){this.canvas=b;this._contextType=null;this.canvas_setContext(b);this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],
onPlay:[],onPause:[],onStop:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;g.extend(this.config,c);g.defaults(this.config,a);g.each(["height","width"],function(b){this.config[b]&&(this["canvas_"+b](this.config[b]),delete this.config[b])},this);return this};c.prototype.addActor=function(b){g.contains(this._actors,b)||(b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup());
return this};c.prototype.getActor=function(b){return this._actors[b]};c.prototype.getActorIds=function(){return g.pluck(this._actors,"id")};c.prototype.getAllActors=function(){return g.clone(this._actors)};c.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=g.without(this._drawOrder,b.id);b.teardown();this.updateInternalState();return this};c.prototype.play=function(b){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+
(e()-this._pausedAtTime):e();this._timesToIterate=b||-1;this._playState="playing";l(this);g.each(this._actors,function(b){b._state.isPaused&&b.resume()});j(this,"onPlayStateChange");j(this,"onPlay");return this};c.prototype.playFrom=function(b,a){this.play(a);this._loopTimestamp=e()-b;return this};c.prototype.playFromCurrent=function(b){return this.playFrom(this._lastRenderedMillisecond,b)};c.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";clearTimeout(this._loopId);
this._pausedAtTime=e();g.each(this._actors,function(b){b._state.isTweening&&b.pause()});j(this,"onPlayStateChange");j(this,"onPause");return this};c.prototype.stop=function(b){this._playState="stopped";clearTimeout(this._loopId);!0===b&&this.canvas_clear();g.each(this._actors,function(a){a.stop();!0===b&&a.hide()});j(this,"onPlayStateChange");j(this,"onStop");return this};c.prototype.isPlaying=function(){return"playing"===this._playState};c.prototype.animationLength=function(){return this._animationLength};
c.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};c.prototype.actorCount=function(){return this._drawOrder.length};c.prototype.framerate=function(b){b&&(this.config.fps=b);return this.config.fps};c.prototype.render=function(b){this.calculateActorPositions(b);this.draw();this._lastRenderedMillisecond=b;j(this,"onFrameRender");return this};c.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};c.prototype.calculateActorPositions=
function(b){var a,c,e;e=p.util.isRoundingEnabled();this.config.doRoundNumbers?p.util.enableRounding():p.util.disableRounding();c=this._drawOrder.length;for(a=0;a<c;a++)this._actors[this._drawOrder[a]].calculatePosition(b);!0===e?p.util.enableRounding():p.util.disableRounding();return this};c.prototype.draw=function(){var b,a,c,e,d;this.config.clearOnUpdate&&this.canvas_clear();a=this._drawOrder.length;e=this.canvas_getContext();this._drawOrderSorter?(b=g.sortBy(this._actors,this._drawOrderSorter),
d=g.pluck(b,"id")):d=this._drawOrder;for(b=0;b<a;b++)c=this._actors[d[b]],c.isShowing()&&c.draw(e,c.get());return this};c.prototype.updateInternalState=function(){var b=[];g.each(this._actors,function(a){b.push(a.getEnd())});this._animationLength=Math.max.apply(Math,b);return this};c.prototype.moveActorToLayer=function(b,a){if(a<this._drawOrder.length)return this._drawOrder=g.without(this._drawOrder,b.id),this._drawOrder.splice(a,0,b.id),b};c.prototype.bind=function(a,c){if(this._events[a])return this._events[a].push(c),
this};c.prototype.unbind=function(a,c){if(this._events[a])return this._events[a]=c?g.without(this._events[a],c):[],this};c.prototype.setOrderFunction=function(a){this._drawOrderSorter=a;return this};c.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};c.prototype.exportTimeline=function(){var a={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};g.each(this._drawOrder,function(c){a.actors[c]=this._actors[c].exportTimeline()},this);return a};
c.util={};g.extend(c.util,{noop:function(){},sortNumerically:d,calculateLoopPosition:o,calculateTimeSinceStart:m});"undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG&&(c._private={sortNumerically:d,calculateLoopPosition:o,renderCurrentMillisecond:i,tick:l,determineCurrentLoopIteration:k,calculateTimeSinceStart:m,isAnimationComplete:n,updatePlayState:q});h.Kapi=c},w=function(h,f){function d(a,e){var c,b,g;g=a._timelinePropertyCacheIndex;b=g.length;for(c=1;c<b;c++)if(g[c]>=e)return c-1;return-1}function k(a){g.each(a._propertyTracks,
function(e,c){a._propertyTracks[c]=g.sortBy(a._propertyTracks[c],function(a){return a.millisecond})})}function m(a){g.each(a._timelinePropertyCaches,function(e,c){var b={};g.each(a._propertyTracks,function(a,e){var d=null;g.find(a,function(a){a.millisecond>c&&(b[e]=d);d=a;return!!b[e]})});g.defaults(e,b)})}function n(a){g.each(a._propertyTracks,function(a){g.each(a,function(c,b){c.linkToNext(a[b+1])})})}function q(a,e,c){return g.find(a._propertyTracks[e],function(a){return a.millisecond===c})}function o(a,
e,c,b){var d=g.keys(a._propertyTracks),f=g.keys(e),d=g.difference(d,f),i={};g.each(d,function(c){var e;e=a._propertyTracks[c].slice(0).reverse();g.each(e,function(a){a.millisecond<b&&!i[c]&&(i[c]={value:a.value,easing:a.easing})})});g.each(i,function(a,b){e[b]=a.value;c[b]=a.easing})}var i,l,j,g=f&&f.underscore?f.underscore:h._,p=f&&f.Tweenable?f.Tweenable:h.Tweenable;i=h.Kapi;l=0;i.Actor=function(a){a=a||{};this.constructor.call(this);g.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},
_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isShowing:!1,_isPersisting:!1,id:l++,setup:a.setup||i.util.noop,draw:a.draw||i.util.noop,teardown:a.teardown||i.util.noop});return this};j=function(){};j.prototype=p.prototype;i.Actor.prototype=new j;i.Actor.prototype.keyframe=function(a,e,c){var b;c||(c="linear");"string"===typeof c&&(b=c,c={},g.each(e,function(a,e){c[e]=b}));g.each(e,function(a,b){c[b]=c[b]||"linear"});o(this,e,c,a);g.each(e,function(b,e){var g;g=new i.KeyframeProperty(this,
a,e,b,c[e]);this._keyframeProperties[g.id]=g;this._propertyTracks[e]||(this._propertyTracks[e]=[]);this._propertyTracks[e].push(g);k(this)},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};i.Actor.prototype.getKeyframeProperty=function(a,e){if(this._propertyTracks[a]&&this._propertyTracks[a][e])return this._propertyTracks[a][e]};i.Actor.prototype.modifyKeyframeProperty=function(a,e,c){this._propertyTracks[a]&&this._propertyTracks[a][e]&&this._propertyTracks[a][e].modifyWith(c);
k(this);this.invalidatePropertyCache();return this};i.Actor.prototype.getTrackNames=function(){return g.keys(this._propertyTracks)};i.Actor.prototype.getTrackLength=function(a){if(this._propertyTracks[a])return this._propertyTracks[a].length};i.Actor.prototype.copyProperties=function(a,e){var c,b;c={};b={};g.each(this._propertyTracks,function(a,g){var d;if(d=q(this,g,e))c[g]=d.value,b[g]=d.easing},this);this.keyframe(a,c,b);return this};i.Actor.prototype.wait=function(a){var e=this.getEnd();if(a<=
e)return this;this.copyProperties(a,e);return this};i.Actor.prototype.getStart=function(){var a=[];g.each(this._propertyTracks,function(e){e.length&&a.push(e[0].millisecond)});0===a.length&&(a=[0]);return Math.min.apply(Math,a)};i.Actor.prototype.getEnd=function(){var a=0;g.each(this._propertyTracks,function(e){e.length&&(e=g.last(e).millisecond,e>a&&(a=e))},this);return a};i.Actor.prototype.getLength=function(){return this.getEnd()-this.getStart()};i.Actor.prototype.modifyKeyframe=function(a,e,c){c=
c||{};g.each(this._propertyTracks,function(b,g){var d=q(this,g,a);d&&d.modifyWith({value:e[g],easing:c[g]})},this);return this};i.Actor.prototype.removeKeyframe=function(a){g.each(this._propertyTracks,function(e){var c=-1;g.find(e,function(b){c++;return a===b.millisecond});(e=e.splice(c,1)[0])&&delete this._keyframeProperties[e.id]},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};i.Actor.prototype.removeAllKeyframeProperties=function(){g.each(this._propertyTracks,
function(a){a.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};i.Actor.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};i.Actor.prototype.show=function(a){this._isShowing=!0;this._isPersisting=!!a;return this};i.Actor.prototype.hide=function(a){this._isShowing=!1;!0===a&&(this._isPersisting=!1);return this};i.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};i.Actor.prototype.calculatePosition=function(a){var e,c,
b;e=this.getStart();c=this.getEnd();this.hide();e<=a&&a<=c&&(this.show(),e=d(this,a),e=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[e]],b={},g.each(e,function(c,e){b[e]=c.getValueAt(a)}),this.set(b));return this};i.Actor.prototype.data=function(a){a&&(this._data=a);return this._data};i.Actor.prototype.exportTimeline=function(){var a={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};g.each(this._propertyTracks,function(e,c){var b=a.propertyTracks[c]=
[];g.each(e,function(a){b.push(a.exportPropertyData())})});return a};i.Actor.prototype.invalidatePropertyCache=function(){this._timelinePropertyCaches={};g.each(this._keyframeProperties,function(a){this._timelinePropertyCaches[a.millisecond]||(this._timelinePropertyCaches[a.millisecond]={});this._timelinePropertyCaches[a.millisecond][a.name]=a},this);this._timelinePropertyCacheIndex=g.keys(this._timelinePropertyCaches);g.each(this._timelinePropertyCacheIndex,function(a,e){this._timelinePropertyCacheIndex[e]=
+a},this);i.util.sortNumerically(this._timelinePropertyCacheIndex);m(this);n(this)};g.each(["tween","to"],function(a){i.Actor.prototype[a]=function(){this.show(!0);p.prototype[a].apply(this,arguments)}},this)},x=function(h){function f(d,f,h,n){"undefined"!==typeof n&&(d[h]=n,d.style||(d.style={}),d.style[h]=n+"px");return f===f.HTML_ELEMENT?d.style[h]:d[h]}h=h.Kapi;h.prototype.canvas_setContext=function(d){var f;this._canvas=d;f=d.nodeName;void 0===f?(this._context={},this._contextType="other"):"CANVAS"===
f?(this._context=d.getContext("2d"),this._contextType="canvas"):(this._context=d,this._contextType="HTMLElement");return this.canvas_getContext()};h.prototype.canvas_getContext=function(){return this._context};h.prototype.canvas_height=function(d){return f(this.canvas,this._contextType,"height",d)};h.prototype.canvas_width=function(d){return f(this.canvas,this._contextType,"width",d)};h.prototype.canvas_style=function(d,f){"undefined"!==typeof f&&this.canvas.style&&(this.canvas.style[d]=f);return this.canvas.style[d]};
h.prototype.canvas_clear=function(){"canvas"===this._contextType&&this.canvas_getContext().clearRect(0,0,this.canvas_width(),this.canvas_height());return this}},y=function(h,f){var d,k=f&&f.underscore?f.underscore:h._,m=f&&f.Tweenable?f.Tweenable:h.Tweenable;d=h.Kapi;d.KeyframeProperty=function(d,f,h,i,l){this.id=k.uniqueId("keyframeProperty_");this.ownerActor=d;this.millisecond=f;this.name=h;this.value=i;this.easing=l||"linear";this.nextProperty=null;return this};d.KeyframeProperty.prototype.modifyWith=
function(d){var f={};k.each(["millisecond","easing","value"],function(h){f[h]="undefined"===typeof d[h]?this[h]:d[h]},this);k.extend(this,f)};d.KeyframeProperty.prototype.linkToNext=function(d){this.nextProperty=d||null};d.KeyframeProperty.prototype.getValueAt=function(d){var f,h,i;f={};h={};this.nextProperty?(f[this.name]=this.value,h[this.name]=this.nextProperty.value,i=this.nextProperty.millisecond-this.millisecond,d=(d-this.millisecond)/i,f=m.util.interpolate(f,h,d,this.nextProperty.easing)[this.name]):
f=null;return f};d.KeyframeProperty.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},s=function(h,f){var d=h.Kapi,k=f&&f.underscore?f.underscore:h._,m=["transform","webkitTransform","MozTransform","oTransform","msTransform"];window.getComputedStyle&&(d.DOMActor=function(f){var h;h=new d.Actor({setup:function(){var d=this.kapi.canvas_getContext();"static"===window.getComputedStyle(d).getPropertyValue("position")&&
(this.kapi.canvas_getContext().style.position="relative");"static"===window.getComputedStyle(f).getPropertyValue("position")&&(f.style.position="absolute");this.hide()},draw:function(d,h){var l;l=!1;k.each(h,function(d,g){l=!0;"rotate"===g?k.each(m,function(g){f.style[g]="rotate("+d+"deg)"}):f.style[g]=d});l?this.show():this.hide()}});f.classList.add(h.getCSSName());h.show=function(h){d.Actor.prototype.show.call(this,h);f.style.display="block"};h.hide=function(h){d.Actor.prototype.hide.call(this,
h);f.style.display="none"};return h},h.Kapi.Actor.prototype.getCSSName=function(){return"actor-"+this.id})},t=function(h,f,d){function k(g){var d=["{"],a;o.each(g.get(),function(e,c){if(/rgb/.test(e))a=e;else{var b=e.match(/\D*$/);a=parseFloat(e).toFixed(2)+b}d.push(c+":"+a+";")});d.push("}");return d.join("")}function m(g,d,a){var a=a||["w3"],e=[];o.each(a,function(a){a=j(i,[q[a],d,g]);e.push(a)});return e.join("\n")}function n(g,d){var d=d||["w3"],a=[],e;o.each(d,function(c){var b=[],c=q[c],d=g.getStart(),
f=g.getEnd()-d,f=j("  %sanimation-duration: %sms;",[c,f]);b.push(f);f=j("  %sanimation-name: %s;",[c,g.getCSSName()+"-keyframes"]);b.push(f);d=j("  %sanimation-delay: %sms;",[c,d]);b.push(d);c=j("  %sanimation-fill-mode: forwards;",[c]);b.push(c);e=b.join("\n");a.push(e)});return j(l,[g.getCSSName(),a.join("\n")])}var q=h.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},o=d&&d.underscore?d.underscore:f._,i="@%skeyframes %s-keyframes {\n%s\n}",l=".%s {\n  position: absolute;\n%s\n}";
f.Kapi.prototype.toCSS=function(d){var d=d||{},f=[],a=this.getActorIds();o.each(a,function(a){f.push(this.getActor(a).toCSS(d))},this);return f.join("\n")};f.Kapi.Actor.prototype.toCSS=function(d){var d=d||{},f=[],a=d.granularity||100,e=n(this,d.vendors);f.push(e);for(var e=this.getLength(),c=this.getStart(),b=[],h,i=e/a,j=e/100,a=c;a<=e+c;a+=i)this.calculatePosition(a),h=(a-c)/j,h=0===h?"from ":100===h?"to ":h.toFixed(2)+"% ",b.push("  "+h+k(this));e=b.join("\n");d=m(e,this.getCSSName(),d.vendors);
f.push(d);return f.join("\n")};var j=h.util.printf=function(d,f){var a=d;o.each(f,function(d){a=a.replace("%s",d)});return a}},u=function(h,f){var d=f?{}:h;v(d,f);w(d,f);x(d,f);y(d,f);"function"===typeof s&&s(d,f);"function"===typeof t&&t(d.Kapi,d,f);return d.Kapi};if("function"===typeof define&&define.amd){var z="undefined"!==typeof _;define(["shifty","underscore"],function(h,f){var d={Tweenable:h,underscore:null!==f?f:_},k=u(r,d);"undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG&&(k.underscore_version=
d.underscore.VERSION);z||delete r._;return k})}else u("undefined"!==typeof r?r:this)})(this);
